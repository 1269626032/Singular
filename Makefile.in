#################################################################
###
### Top-level Makefile for Singular
###
### The main purpose of this Makefile is to call `make'
### recursively in the subdirectories determined at configuration
### time.
###
#################################################################

@SET_MAKE@
SHELL		= /bin/sh

SINGULAR	= @SINGULAR@

BUILD_SUBDIRS	= @BUILD_SUBDIRS@
SUBDIRS		= @SUBDIRS@

PERL		= @PERL@
TMP_DIR		= @TMP_DIR@
MYGZIP		= @MYGZIP@
GUNZIP		= @GUNZIP@

##############################################################
# default target
${SINGULAR}:
	${MAKE} install

##############################################################
# general targets
# simply descend for these targets
.PHONY: all install uninstall

TEXINFO_TEX_FILES = epsf.tex texinfo.tex txi-cs.tex txi-de.tex txi-no.tex
TEXINFO_TEX_DIR = Texinfo/doc
all install uninstall:
	@ for SUBDIR in ${BUILD_SUBDIRS}; \
	do \
	  echo ${MAKE} $@ in $${SUBDIR}; \
	  ( cd $${SUBDIR} && ${MAKE} $@;); \
	  (if test "$${SUBDIR}" = Texinfo && test -d doc; then \
		for FILE in ${TEXINFO_TEX_FILES}; \
		do \
		  if test "$@" = uninstall; then\
		    echo rm -f doc/$${FILE};\
                    rm -f doc/$${FILE}; \
                  else \
		    echo cp ${TEXINFO_TEX_DIR}/$${FILE} doc; \
		    cp ${TEXINFO_TEX_DIR}/$${FILE} doc; \
                  fi; \
                done;\
          fi;); \
	done

install-doc:
	cd doc; make install

##############################################################
# cleaning up
.PHONY: local-clean local-distclean local-maintainer-clean \
        clean distclean mostlyclean maintainer-clean

# we use a canned sequence to avoid code redundancy
define recurse
@ for SUBDIR in ${SUBDIRS}; \
do \
  echo ${MAKE} $@ in $${SUBDIR}; \
  ( cd $${SUBDIR} && ${MAKE} $@; ) \
done
endef

local-clean:
	rm -rf *~ a.out core *.o *.log

local-distclean: local-clean
	rm -rf Makefile config.cache config.log config.status TAGS* *.gz *.tar

local-maintainer-clean: local-distclean
	@ echo "This command is intended for maintainer use, only"
	rm -rf configure

clean mostlyclean: local-clean
	$(recurse)

distclean: local-distclean
	$(recurse)

maintainer-clean: uninstall local-maintainer-clean
	$(recurse)

##############################################################
# some extra targets for the specific packages
.PHONY: factory libfac MP gmp smallgmp
Singular factory libfac MP gmp smallgmp:
	cd $@; ${MAKE} all

##############################################################
# documentation
.PHONY: info dvi ps doc doc/singular.hlp html

info dvi ps doc/singular.hlp html: ${SINGULAR}
	cd doc; ${MAKE} $@

doc info/singular.hlp:
	cd doc; ${MAKE} install

##############################################################
# Tst targets
.PHONY:	Tst-All Tst Tst-Old Tst-Short Tst-Long
Tst-All: Tst-Old Tst-Short Tst-Long

Tst: Tst-Old Tst-Short

Tst-Old: ${SINGULAR} Tst/Old/universal.lst Tst/regress.cmd
	${PERL} Tst/regress.cmd -r -s ${SINGULAR} Tst/Old/universal.lst

Tst-Short: ${SINGULAR} Tst/Short/ok_s.lst Tst/regress.cmd
	${PERL} Tst/regress.cmd -r -s ${SINGULAR} Tst/Short/ok_s.lst

Tst-Long:  ${SINGULAR} Tst/Long/ok_l.lst Tst/regress.cmd
	${PERL} Tst/regress.cmd -r -s ${SINGULAR} Tst/Long/ok_l.lst

##############################################################
# distribution targets
#
S_VERSION          = $${SINGULAR_VERSION-@SINGULAR_VERSION@}
SINGUNAME	   = @SINGUNAME@
localdir           = /usr/local
install_prefix     = ${localdir}/Singular/${S_VERSION}
CYGWIN_PORT_VER    = @SINGULAR_RPM_VERSION@-1
CYGWIN_SETUP_VER   = 2.457.2.2
CYGWIN_REP_DIR     = cygwin_pkg
CYGWIN_AUX_FILES   = rpm/cygwin
CYGWIN_PFW_DIR     = /cygdrive/c/Programme/InstallShield/PackageForTheWeb\ 4/
CYGWIN_PFW_EXEC    = pftwwiz.exe
#CYGWIN_MAKE_DIR    := $(shell cygpath -a -w .)
CYGWIN_ORIG        = external-cygwin

BINDIST_DIRS        = kernel Singular doc IntegerProgramming modules
PLU_BINDIST_DIRS    = ${BINDIST_DIRS}
SHAREDIST_DIRS      = Singular doc emacs
PLU_SHAREDIST_DIRS  = ${SHAREDIST_DIRS}
TMPDIR		    = ${TMP_DIR}/singdist

LN_S		= @LN_S@
MKINSTALLDIRS 	= ./mkinstalldirs

BINDIST_NAME		= Singular-${S_VERSION}-${SINGUNAME}
PLU_BINDIST_NAME	= SingularPlural-${S_VERSION}-${SINGUNAME}
SHAREDIST_NAME  	= Singular-${S_VERSION}-share
PLU_SHAREDIST_NAME  	= SingularPlural-${S_VERSION}-share


install-dist install-local: install-bindist install-sharedist

install-bindist:
	for DIR in ${BINDIST_DIRS}; \
	do \
	  if test -d $${DIR}; then \
	    (cd $${DIR}; ${MAKE} install-bindist install_prefix=${install_prefix});\
	  fi \
	done

install-bindist-plural:
	for DIR in ${PLU_BINDIST_DIRS}; \
	do \
	  if test -d $${DIR}; then \
	    (cd $${DIR}; ${MAKE} install-bindist-plural install_prefix=${install_prefix});\
	  fi \
	done

install-sharedist: ${SINGULAR}
	for DIR in ${SHAREDIST_DIRS}; \
	do \
	  (cd $${DIR}; ${MAKE} install-sharedist install_prefix=${install_prefix}); \
	done

install-sharedist-plural: ${SINGULAR}
	for DIR in ${PLU_SHAREDIST_DIRS}; \
	do \
	  (cd $${DIR}; ${MAKE} install-sharedist-plural install_prefix=${install_prefix}); \
	done

dist: ${SHAREDIST_NAME}.tar.gz  ${BINDIST_NAME}.tar.gz

dist-plural: ${PLU_SHAREDIST_NAME}.tar.gz  ${PLU_BINDIST_NAME}.tar.gz

sharedist ${SHAREDIST_NAME}.tar.gz:
	if test -d ${TMPDIR}; then rm -rf ${TMPDIR}; fi
	${MAKE} install-sharedist localdir=${TMPDIR}
	chmod -R a+rX ${TMPDIR}
	cd ${TMPDIR}; tar cf ${SHAREDIST_NAME}.tar Singular; ${MYGZIP} ${SHAREDIST_NAME}.tar
	mv ${TMPDIR}/${SHAREDIST_NAME}.tar.gz .
	rm -rf ${TMPDIR}

sharedist-plural ${PLU_SHAREDIST_NAME}.tar.gz:
	if test -d ${TMPDIR}; then rm -rf ${TMPDIR}; fi
	${MAKE} install-sharedist-plural localdir=${TMPDIR}
	chmod -R a+rX ${TMPDIR}
	cd ${TMPDIR}; tar cf ${SHAREDIST_NAME}.tar Singular; ${MYGZIP} ${SHAREDIST_NAME}.tar
	mv ${TMPDIR}/${SHAREDIST_NAME}.tar.gz .
	rm -rf ${TMPDIR}

bindist ${BINDIST_NAME}.tar.gz:
	if test -d ${TMPDIR}; then rm -fr ${TMPDIR}; fi
	${MAKE} install-bindist localdir=${TMPDIR}
	chmod -R a+rX ${TMPDIR}
	cd ${TMPDIR}; tar cf ${BINDIST_NAME}.tar Singular; ${MYGZIP} ${BINDIST_NAME}.tar
	mv ${TMPDIR}/${BINDIST_NAME}.tar.gz .
	rm -rf ${TMPDIR}

static-bindist ${BINDIST_NAME}-static.tar.gz:
	if test -d ${TMPDIR}; then rm -fr ${TMPDIR}; fi
	${MAKE} install-bindist localdir=${TMPDIR} LD_STATIC=1
	chmod -R a+rX ${TMPDIR}
	cd ${TMPDIR}; tar cf ${BINDIST_NAME}-static.tar Singular; ${MYGZIP} ${BINDIST_NAME}-static.tar
	mv ${TMPDIR}/${BINDIST_NAME}-static.tar.gz .
	rm -rf ${TMPDIR}

static-bindist-plural ${PLU_BINDIST_NAME}-static.tar.gz:
	if test -d ${TMPDIR}; then rm -fr ${TMPDIR}; fi
	${MAKE} install-bindist-plural localdir=${TMPDIR} LD_STATIC=1
	chmod -R a+rX ${TMPDIR}
	cd ${TMPDIR}; tar cf ${BINDIST_NAME}-static.tar Singular; ${MYGZIP} ${BINDIST_NAME}-static.tar
	mv ${TMPDIR}/${BINDIST_NAME}-static.tar.gz .
	rm -rf ${TMPDIR}

install-root:
	${MKINSTALLDIRS} ${localdir}/bin
	${LN_S} ${localdir}/Singular/${S_VERSION}/${SINGUNAME}/Singular ${localdir}/bin/Singular-${S_VERSION}
	${LN_S} ${localdir}/Singular/${S_VERSION}/${SINGUNAME}/ESingular ${localdir}/bin/ESingular-${S_VERSION}

##############################################################
# targets for the windows distribution
#

cygwin-dist-src ${SHAREDIST_NAME}.tar.bz2:
	-rm -rf ${TMPDIR}
	${MKINSTALLDIRS} ${TMPDIR}/singular-${CYGWIN_PORT_VER}
	cd ${TMPDIR}/singular-${CYGWIN_PORT_VER}; cvs co All
	cd  ${TMPDIR}; \
	tar cjf singular-base-${CYGWIN_PORT_VER}-src.tar.bz2 singular-${CYGWIN_PORT_VER};
	mv ${TMPDIR}/singular-base-${CYGWIN_PORT_VER}-src.tar.bz2 .
	-rm -rf ${TMPDIR}

cygwin-dist-install: ${BINDIST_NAME}.tar.gz
	-rm -r /usr/Singular/${S_VERSION}
	tar  --directory=/usr -x -z -f ${SHAREDIST_NAME}.tar.gz
	-rm -r -f /usr/Singular/${S_VERSION}/html
	tar  --directory=/usr -x -z -f ${BINDIST_NAME}.tar.gz
	cp ${CYGWIN_AUX_FILES}/surf.exe /usr/Singular/${S_VERSION}/ix86-Win
	cp ${CYGWIN_AUX_FILES}/SURF_AUTHORS /usr/Singular/${S_VERSION}/ix86-Win
	cp ${CYGWIN_AUX_FILES}/SURF_README /usr/Singular/${S_VERSION}/ix86-Win
	cp ${CYGWIN_AUX_FILES}/SURF_COPYING /usr/Singular/${S_VERSION}/ix86-Win
	cp ${CYGWIN_AUX_FILES}/Manual.chm /usr/Singular/${S_VERSION}/doc
	cp ${CYGWIN_AUX_FILES}/startxserver.bat /usr/Singular/${S_VERSION}/ix86-Win
	cp ${CYGWIN_AUX_FILES}/get_startmenu.exe /usr/Singular/${S_VERSION}/ix86-Win
	wget http://cygwin.com/setup.exe -O /usr/Singular/${S_VERSION}/ix86-Win/cygwin-setup.exe
	cp ${CYGWIN_AUX_FILES}/singular-helper.sh /etc/postinstall/
	cp ${CYGWIN_AUX_FILES}/startxserver.bat /usr/X11R6/bin/
	cp ${CYGWIN_AUX_FILES}/Singular /usr/bin
	cp ${CYGWIN_AUX_FILES}/ESingular /usr/bin
	cp ${CYGWIN_AUX_FILES}/singular-base.README /usr/share/doc/Cygwin/singular-base-${CYGWIN_PORT_VER}.README
	cp ${CYGWIN_AUX_FILES}/singular-share.README /usr/share/doc/Cygwin/singular-share-${CYGWIN_PORT_VER}.README
	cp ${CYGWIN_AUX_FILES}/singular-help.README /usr/share/doc/Cygwin/singular-help-${CYGWIN_PORT_VER}.README
	cp ${CYGWIN_AUX_FILES}/singular-surf.README /usr/share/doc/Cygwin/singular-surf-${CYGWIN_PORT_VER}.README

cygwin-dist-pack: ${SHAREDIST_NAME}.tar.bz2
	-rm -r -f ${CYGWIN_REP_DIR}
	mkdir ${CYGWIN_REP_DIR}
	mkdir ${CYGWIN_REP_DIR}/release
	mkdir ${CYGWIN_REP_DIR}/release/singular-base
	mkdir ${CYGWIN_REP_DIR}/release/singular-share
	mkdir ${CYGWIN_REP_DIR}/release/singular-help
	mkdir ${CYGWIN_REP_DIR}/release/singular-surf
	mkdir ${CYGWIN_REP_DIR}/release/singular-helper
	tar cjf ${CYGWIN_REP_DIR}/release/singular-base/singular-base-${CYGWIN_PORT_VER}.tar.bz2 \
	      /usr/Singular/${S_VERSION}/COPYING  \
	      /usr/Singular/${S_VERSION}/INSTALL  \
	      /usr/Singular/${S_VERSION}/NEWS     \
	      /usr/Singular/${S_VERSION}/README   \
	      /usr/bin/Singular                  \
	      /usr/bin/ESingular                 \
	      /usr/Singular/${S_VERSION}/ix86-Win/*Singular*       \
	      /usr/Singular/${S_VERSION}/ix86-Win/solve_IP.exe     \
	      /usr/Singular/${S_VERSION}/ix86-Win/toric_ideal.exe  \
	      /usr/Singular/${S_VERSION}/ix86-Win/change_cost.exe  \
	      /usr/Singular/${S_VERSION}/ix86-Win/LLL.exe	  \
	      /usr/Singular/${S_VERSION}/ix86-Win/libparse.exe     \
	      /usr/Singular/${S_VERSION}/ix86-Win/gen_test.exe
	tar cjf ${CYGWIN_REP_DIR}/release/singular-share/singular-share-${CYGWIN_PORT_VER}.tar.bz2 \
	      /usr/Singular/${S_VERSION}/COPYING  \
	      /usr/Singular/${S_VERSION}/INSTALL  \
	      /usr/Singular/${S_VERSION}/NEWS     \
	      /usr/Singular/${S_VERSION}/README   \
	      /usr/Singular/${S_VERSION}/emacs    \
	      /usr/Singular/${S_VERSION}/LIB      \
	      /usr/Singular/${S_VERSION}/examples
	tar cjf ${CYGWIN_REP_DIR}/release/singular-help/singular-help-${CYGWIN_PORT_VER}.tar.bz2 \
	      /usr/Singular/${S_VERSION}/doc      \
	      /usr/Singular/${S_VERSION}/info
	tar cjf ${CYGWIN_REP_DIR}/release/singular-surf/singular-surf-${CYGWIN_PORT_VER}.tar.bz2 \
	      /usr/Singular/${S_VERSION}/ix86-Win/surf.exe       \
	      /usr/Singular/${S_VERSION}/ix86-Win/SURF_AUTHORS   \
	      /usr/Singular/${S_VERSION}/ix86-Win/SURF_README    \
	      /usr/Singular/${S_VERSION}/ix86-Win/SURF_COPYING
	tar cjf ${CYGWIN_REP_DIR}/release/singular-helper/singular-helper-${CYGWIN_PORT_VER}.tar.bz2 \
	      /usr/Singular/${S_VERSION}/ix86-Win/cygwin-setup.exe                \
	      /usr/X11R6/bin/startxserver.bat                                    \
	      /etc/postinstall/singular-helper.sh
	cp singular-base-${CYGWIN_PORT_VER}-src.tar.bz2 ${CYGWIN_REP_DIR}/release/singular-base/
	cp ${CYGWIN_AUX_FILES}/singular-surf-${CYGWIN_PORT_VER}-src.tar.bz2 ${CYGWIN_REP_DIR}/release/singular-surf/
	cp ${CYGWIN_AUX_FILES}/setup-base.hint ${CYGWIN_REP_DIR}/release/singular-base/setup.hint
	cp ${CYGWIN_AUX_FILES}/setup-share.hint ${CYGWIN_REP_DIR}/release/singular-share/setup.hint
	cp ${CYGWIN_AUX_FILES}/setup-help.hint ${CYGWIN_REP_DIR}/release/singular-help/setup.hint
	cp ${CYGWIN_AUX_FILES}/setup-surf.hint ${CYGWIN_REP_DIR}/release/singular-surf/setup.hint
	cp ${CYGWIN_AUX_FILES}/setup-helper.hint ${CYGWIN_REP_DIR}/release/singular-helper/setup.hint

cygwin-dist: cygwin-dist-install cygwin-dist-pack cygwin-setup

cygwin-setup-init:
	echo "# This file is automatically generated by Makefile." > ${CYGWIN_REP_DIR}/setup.ini
	echo "# Special for Singular Distribution." >> ${CYGWIN_REP_DIR}/setup.ini
	echo -n "setup-timestamp: " >> ${CYGWIN_REP_DIR}/setup.ini
	echo `perl -e 'print time'` >> ${CYGWIN_REP_DIR}/setup.ini
	echo "setup-version: ${CYGWIN_SETUP_VER}" >> ${CYGWIN_REP_DIR}/setup.ini
	echo >> ${CYGWIN_REP_DIR}/setup.ini
	cat ${CYGWIN_AUX_FILES}/setup.ini ${CYGWIN_REP_DIR}/setup.ini
	echo >> ${CYGWIN_REP_DIR}/setup.ini
	wget http://cygwin.com/setup.exe -O ${CYGWIN_REP_DIR}/setup.exe

cygwin-setup: cygwin-setup-init cygwin-setup-base cygwin-setup-share cygwin-setup-help cygwin-setup-surf cygwin-setup-helper
	cp ${CYGWIN_REP_DIR}/setup.ini ${CYGWIN_REP_DIR}/setup
	cd ${CYGWIN_REP_DIR} && bzip2 -f setup
	cd ${CYGWIN_REP_DIR} && md5sum setup.* | sed -e 's/*//g' > md5.sum

cygwin-setup-%:
	echo "@ singular-$*" >> ${CYGWIN_REP_DIR}/setup.ini
	cat ${CYGWIN_REP_DIR}/release/singular-$*/setup.hint >> ${CYGWIN_REP_DIR}/setup.ini
	echo "version: ${CYGWIN_PORT_VER}" >> ${CYGWIN_REP_DIR}/setup.ini
	echo -n "install: release/singular-$*/singular-$*-${CYGWIN_PORT_VER}.tar.bz2 "  >> ${CYGWIN_REP_DIR}/setup.ini
	echo -n `du -b ${CYGWIN_REP_DIR}/release/singular-$*/singular-$*-${CYGWIN_PORT_VER}.tar.bz2 | sed -e 's/\([0-9]*\).*/\1/g'` >> ${CYGWIN_REP_DIR}/setup.ini
	echo -n " " >> ${CYGWIN_REP_DIR}/setup.ini
	echo `md5sum ${CYGWIN_REP_DIR}/release/singular-$*/singular-$*-${CYGWIN_PORT_VER}.tar.bz2 | sed -e 's/\([a-zA-Z0-9]*\).*/\1/g'` >> ${CYGWIN_REP_DIR}/setup.ini
	if test -e ${CYGWIN_REP_DIR}/release/singular-$*/singular-$*-${CYGWIN_PORT_VER}-src.tar.bz2; then \
	  echo -n "source: release/singular-$*/singular-$*-${CYGWIN_PORT_VER}-src.tar.bz2 "  >> ${CYGWIN_REP_DIR}/setup.ini; \
	  echo -n `du -b ${CYGWIN_REP_DIR}/release/singular-$*/singular-$*-${CYGWIN_PORT_VER}-src.tar.bz2 | sed -e 's/\([0-9]*\).*/\1/g'` >> ${CYGWIN_REP_DIR}/setup.ini; \
	  echo -n " " >> ${CYGWIN_REP_DIR}/setup.ini; \
	  echo `md5sum ${CYGWIN_REP_DIR}/release/singular-$*/singular-$*-${CYGWIN_PORT_VER}-src.tar.bz2 | sed -e 's/\([a-zA-Z0-9]*\).*/\1/g'` >> ${CYGWIN_REP_DIR}/setup.ini; \
	else \
	  echo -n "source: release/singular-base/singular-base-${CYGWIN_PORT_VER}-src.tar.bz2 "  >> ${CYGWIN_REP_DIR}/setup.ini; \
	  echo -n `du -b ${CYGWIN_REP_DIR}/release/singular-base/singular-base-${CYGWIN_PORT_VER}-src.tar.bz2 | sed -e 's/\([0-9]*\).*/\1/g'` >> ${CYGWIN_REP_DIR}/setup.ini; \
	  echo -n " " >> ${CYGWIN_REP_DIR}/setup.ini; \
	  echo `md5sum ${CYGWIN_REP_DIR}/release/singular-base/singular-base-${CYGWIN_PORT_VER}-src.tar.bz2 | sed -e 's/\([a-zA-Z0-9]*\).*/\1/g'` >> ${CYGWIN_REP_DIR}/setup.ini; \
	fi;
	echo >> ${CYGWIN_REP_DIR}/setup.ini

cygwin-pfw: cygwin-pfw-Full ## cygwin-pfw-Small

cygwin-pfw-%:
	if test -d ${TMPDIR}; then rm -rf ${TMPDIR}; fi
	mkinstalldirs ${TMPDIR}/Files
	cp -r ${CYGWIN_ORIG}/$*/* ${TMPDIR}/Files/
	if test "$$*" = Full; then \
	  cp -r ${CYGWIN_REP_DIR}/release/singular* ${TMPDIR}/Files/release/; \
	else \
	  cp -r ${CYGWIN_REP_DIR}/release/singular-base ${TMPDIR}/Files/release/; \
	  cp -r ${CYGWIN_REP_DIR}/release/singular-helper ${TMPDIR}/Files/release/; \
	  cp -r ${CYGWIN_REP_DIR}/release/singular-help ${TMPDIR}/Files/release/; \
	  cp -r ${CYGWIN_REP_DIR}/release/singular-share ${TMPDIR}/Files/release/; \
	fi;
	-rm -f  ${TMPDIR}/Files/release/singular-base/*src.tar.bz2
	-rm -f  ${TMPDIR}/Files/release/singular-surf/*src.tar.bz2
	cat ${CYGWIN_REP_DIR}/setup.ini | sed -e 's/setup-version:.*//' | sed -e 's/setup-timestamp:.*//' >> ${TMPDIR}/Files/setup.ini
	@echo Writing Singular.pfw ...
	@echo "Version=2.0" >> ${TMPDIR}/Singular.pfw
	@echo "" >> ${TMPDIR}/Singular.pfw
	@echo "[Options]" >> ${TMPDIR}/Singular.pfw
	@echo "Title=Singular ${S_VERSION}: $* Distribution" >> ${TMPDIR}/Singular.pfw
	@echo "Company=Department of Mathematics and Center for Computer Algebra, University of Kaiserslautern" >> ${TMPDIR}/Singular.pfw
	@echo "CompanyEMail=singular@mathematik.uni-kl.de" >> ${TMPDIR}/Singular.pfw
	@echo -n "BasePath="  >> ${TMPDIR}/Singular.pfw
	@echo `cygpath -a -w ${TMPDIR}/Files` >> ${TMPDIR}/Singular.pfw
	@echo "ImportPath=" >> ${TMPDIR}/Singular.pfw
	@echo "UseRTF=1" >> ${TMPDIR}/Singular.pfw
	@echo "SaveFiles=0" >> ${TMPDIR}/Singular.pfw
	@echo "SubFolders=1" >> ${TMPDIR}/Singular.pfw
	@echo "ApplicationName=Singular ${S_VERSION} Build `date -u +%D' UTC '%T`" >> ${TMPDIR}/Singular.pfw
	@echo "Description=A Computer Algebra System For Polynomial Computations" >> ${TMPDIR}/Singular.pfw
	@echo "Comments=Authors: G.-M. Greuel, G. Pfister, H. Schoenemann" >> ${TMPDIR}/Singular.pfw
	@echo "Notice=Distributed under General Public License (GPL)" >> ${TMPDIR}/Singular.pfw
	@echo "Version=3-0-0" >> ${TMPDIR}/Singular.pfw
	@echo -n "OutputSpec=" >> ${TMPDIR}/Singular.pfw
	@echo -n "`cygpath -a -w .`" >> ${TMPDIR}/Singular.pfw
	@echo "\Singular-${S_VERSION}-$*.exe" >> ${TMPDIR}/Singular.pfw
	@echo "GUIDs=0" >> ${TMPDIR}/Singular.pfw
	@echo "Type=2" >> ${TMPDIR}/Singular.pfw
	@echo "Compress=1" >> ${TMPDIR}/Singular.pfw
	@echo "Sign=0" >> ${TMPDIR}/Singular.pfw
	@echo "Transfer=0" >> ${TMPDIR}/Singular.pfw
	@echo "" >> ${TMPDIR}/Singular.pfw
	@echo "[Runtime]" >> ${TMPDIR}/Singular.pfw
	@echo "Welcome=" >> ${TMPDIR}/Singular.pfw
	@echo -n "License=" >> ${TMPDIR}/Singular.pfw
	@echo -n "`cygpath -a -w .`" >> ${TMPDIR}/Singular.pfw
	@echo "\GPL" >> ${TMPDIR}/Singular.pfw
	@echo "Prompt=" >> ${TMPDIR}/Singular.pfw
	@echo "Password=" >> ${TMPDIR}/Singular.pfw
	@echo "DefaultPath=" >> ${TMPDIR}/Singular.pfw
	@echo "Language=English" >> ${TMPDIR}/Singular.pfw
	@echo "WindowStyle=0" >> ${TMPDIR}/Singular.pfw
	@echo "Options=33" >> ${TMPDIR}/Singular.pfw
	@echo "Execute=setup.exe" >> ${TMPDIR}/Singular.pfw
	@echo "CmdLine=-q -n" >> ${TMPDIR}/Singular.pfw
	@echo "AllowChangeTarget=0" >> ${TMPDIR}/Singular.pfw
	@echo "AllowDelete=0" >> ${TMPDIR}/Singular.pfw
	@echo "LaunchEXE=1" >> ${TMPDIR}/Singular.pfw
	@echo "" >> ${TMPDIR}/Singular.pfw
	@echo "[Extension]" >> ${TMPDIR}/Singular.pfw
	@echo "Server=" >> ${TMPDIR}/Singular.pfw
	@echo "Calls=0" >> ${TMPDIR}/Singular.pfw
	cd ${CYGWIN_PFW_DIR}; \
	${CYGWIN_PFW_EXEC} -a -s "`cygpath -a -w ${TMPDIR}/Singular.pfw`"

cygwin-cd-repository:
	mkinstalldirs Repository
	cp -r ${CYGWIN_ORIG}/cd-repository/* Repository/
	cp -r ${CYGWIN_REP_DIR}/release/singular* Repository/release/; \
	cat ${CYGWIN_REP_DIR}/setup.ini | sed -e 's/setup-version:.*//' | sed -e 's/setup-timestamp:.*//' >> Repository/setup.ini

singular-cd-windows: cygwin-dist cygwin-pfw-Full cygwin-repository
	@echo Building cd directories and web interface
	mkinstalldirs singular-cd/WINDOWS/Files/Repository
	echo WEBPAGE FEATURE NOT INTRODUCED
	@echo Buidling cd autostart
	echo AUTOSTART FEATURE NOT INTRODUCED
	@echo Copying PackageForTheWeb
	cp Singualar-${S_VERSION}-$*.exe singular-cd/WINDOWS/Files/
	cp Singualar/singular.ico singular-cd/WINDOWS/Files/
	@echo Building cygwin-cd-repository
	cp -r ${CYGWIN_ORIG}/cd-repository/* singular-cd/WINDOWS/Files/Repository/
	cp -r ${CYGWIN_REP_DIR}/release/singular* singular-cd/WINDOWS/Files/Repository/release/; \
	cat ${CYGWIN_REP_DIR}/setup.ini | sed -e 's/setup-version:.*//' | sed -e 's/setup-timestamp:.*//' >> singular-cd/WINDOWS/Files/Repository/setup.ini

##
## old targets -- need to be updated
##

BINDIR_NAME	= Singular/${S_VERSION}/${SINGUNAME}
LIBDIR_NAME 	= Singular/${S_VERSION}/LIB
GFTABLESDIR_NAME= Singular/${S_VERSION}/LIB/gftables
DOCDIR_NAME 	= Singular/${S_VERSION}/doc
HTMLDIR_NAME	= Singular/${S_VERSION}/html
INFODIR_NAME	= Singular/${S_VERSION}/info
EMACSDIR_NAME	= Singular/${S_VERSION}/emacs

ZIP		= zip

test_t:
	echo ${S_VERSION}

.PHONY: sharedist bindist static-bindist infodist win-sharedist
_static-bindist: ${SINGULAR}
	cd Singular; ${MAKE} Singular-$@ libparse
	rm -rf ${TMPDIR}
	${MKINSTALLDIRS} ${TMPDIR}/${BINDIR_NAME}
	cp Singular/Singular-$@ ${TMPDIR}/${BINDIR_NAME}/Singular-static
	cp Singular/libparse ${TMPDIR}/${BINDIR_NAME}
	-strip ${TMPDIR}/${BINDIR_NAME}/*
	cat INSTALL.unix | sed -e "s/<x-y-z>/${S_VERSION}/g" > \
                      ${TMPDIR}/Singular/INSTALL
	cd ${TMPDIR}; chmod -R a+rX *;\
           tar cf ${BINDIST_NAME}-static.tar Singular; \
           ${MYGZIP} ${BINDIST_NAME}-static.tar
	mv ${TMPDIR}/${BINDIST_NAME}-static.tar.gz .
	rm -rf ${TMPDIR}

_infodist:
	rm -rf ${TMPDIR}
	${MKINSTALLDIRS} ${TMPDIR}/${SINGUNAME}/bin/
	cp `which info` ${TMPDIR}/${SINGUNAME}/bin/
	-strip ${TMPDIR}/${SINGUNAME}/bin/info
	cd ${TMPDIR}; tar cf info-${SINGUNAME}.tar ${SINGUNAME}; \
                      ${MYGZIP} info-${SINGUNAME}.tar
	mv ${TMPDIR}/info-${SINGUNAME}.tar.gz .
	rm -rf ${TMPDIR}

INSTALL		= ./Singular/install-sh -c
SH_PROGRAM 	= /bin/sh
INFO_PROGRAM 	= /bin/info
CYGWIN_DLL	= /bin/cygwin1.dll

windist: ${SINGULAR}
	cd Singular; ${MAKE} install-bindist
	rm -rf ${TMPDIR}
	${MKINSTALLDIRS} ${TMPDIR}/${BINDIR_NAME}
	${INSTALL} Singular/Singular-bindist \
                   ${TMPDIR}/${BINDIR_NAME}/Singular.exe
	${INSTALL} Singular/libparse ${TMPDIR}/${BINDIR_NAME}
	${INSTALL} ${SH_PROGRAM} ${TMPDIR}/${BINDIR_NAME}
	${INSTALL} ${INFO_PROGRAM} ${TMPDIR}/${BINDIR_NAME}
	${INSTALL} ${CYGWIN_DLL} ${TMPDIR}/${BINDIR_NAME}
	cat INSTALL.win	| sed -e "s/<x-y-z>/${S_VERSION}/g" > \
                         ${TMPDIR}/Singular/INSTALL
	cd ${TMPDIR}; chmod -R a+rX *;\
           ${ZIP} -r sing Singular
	mv ${TMPDIR}/sing.zip Singular-${S_VERSION}-${SINGUNAME}.zip
	rm -rf ${TMPDIR}

srcdist:
	rm -rf ${TMPDIR}
	${MKINSTALLDIRS} ${TMPDIR}/Singular-${S_VERSION}
	cd ${TMPDIR}/Singular-${S_VERSION}; cvs co All
	cd  ${TMPDIR}; \
	tar cf Singular-${S_VERSION}.tar Singular-${S_VERSION}; \
	${MYGZIP} Singular-${S_VERSION}.tar
	cp ${TMPDIR}/Singular-${S_VERSION}.tar.gz .
	rm -rf ${TMPDIR}

# You can remeber the password with "iwd" == "ich war dabei"
CRYPT	= enigma # it does not seem to decrypt correctly with the HP crypt
cryptdist: srcdist
	${CRYPT} S-${S_VERSION}-iwd < Singular-${S_VERSION}.tar.gz > Singular-${S_VERSION}.tar.gz.crypt


##############################################################
# stuff for configure
Makefile : Makefile.in config.status
	CONFIG_FILES=Makefile ./config.status

doc/Makefile: doc/Makefile.in config.status
	CONFIG_FILES=doc/Makefile ./config.status

config.status: configure
	./config.status --recheck

configure: configure.in
	@echo "You need to rerun autoconf. I am proceeding, for now."
	@touch configure
# 	autoconf
#
